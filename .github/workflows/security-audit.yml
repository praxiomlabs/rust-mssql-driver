# Scheduled security audit for rust-mssql-driver (CI-002)
# Runs weekly to catch new vulnerabilities in dependencies

name: Security Audit

on:
  # Run weekly on Monday at 9:00 UTC
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:
  # Also run on changes to dependencies
  push:
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - 'deny.toml'

jobs:
  audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo-audit
        run: cargo audit

      - name: Run cargo-deny
        uses: EmbarkStudios/cargo-deny-action@v2
        with:
          log-level: warn
          command: check advisories

  # Check for outdated dependencies
  outdated:
    name: Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-outdated
        run: cargo install cargo-outdated --locked

      - name: Check outdated dependencies
        run: cargo outdated --depth 1 --exit-code 0 || true
        # Don't fail on outdated, just report

  # License compliance check
  licenses:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run cargo-deny license check
        uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check licenses

  # Create issue for vulnerabilities
  notify:
    name: Notify on Vulnerabilities
    runs-on: ubuntu-latest
    needs: [audit]
    if: failure()
    permissions:
      issues: write
    steps:
      - name: Create issue
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'ðŸ”’ Security Audit Failed';
            const body = `The scheduled security audit has detected potential vulnerabilities.

            **Workflow Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            Please review the audit results and update affected dependencies.

            ---
            *This issue was automatically created by the security audit workflow.*`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security'
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies']
              });
            }
