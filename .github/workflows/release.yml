# Release workflow for rust-mssql-driver
# Includes semver checks before publishing (CI-007)

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry run (no actual publish)'
        required: false
        default: true
        type: boolean

env:
  CARGO_TERM_COLOR: always
  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

jobs:
  # Verify semver compliance before release (CI-007)
  semver-check:
    name: Semver Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Install Kerberos headers
        run: sudo apt-get update && sudo apt-get install -y libkrb5-dev
      - name: Get previous tag
        id: prev_tag
        run: |
          # Get the tag before the current one
          PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"
      - uses: obi1kenobi/cargo-semver-checks-action@v2
        with:
          verbose: true
          # Use git tag as baseline to avoid workspace dependency issues.
          # When using crates.io baseline, workspace deps get mixed with local versions.
          baseline-rev: ${{ steps.prev_tag.outputs.tag }}
          # Exclude mssql-testing: testcontainers -> home@0.5.12 requires Rust 1.88,
          # but we support MSRV 1.85. Testing utilities have relaxed API stability requirements.
          # Re-enable when upstream testcontainers updates their dependencies.
          exclude: mssql-testing

  # Run full test suite before release
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@nextest
      - name: Install Kerberos headers
        run: sudo apt-get update && sudo apt-get install -y libkrb5-dev
      - name: Run tests
        run: cargo nextest run --all-features

  # Security audit before release
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: EmbarkStudios/cargo-deny-action@v2

  # Build documentation
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install Kerberos headers
        run: sudo apt-get update && sudo apt-get install -y libkrb5-dev
      - name: Build documentation
        run: cargo doc --all-features --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  # Publish to crates.io
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [semver-check, test, security-audit, docs]
    if: ${{ !inputs.dry_run }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      # Publish in dependency order with waits for crates.io index propagation
      # Tier 0: Independent crates (no internal dependencies)
      - name: Publish tds-protocol
        run: cargo publish -p tds-protocol --no-verify
        continue-on-error: true  # May already be published

      - name: Publish mssql-types
        run: cargo publish -p mssql-types --no-verify
        continue-on-error: true

      # Wait for crates.io index to update
      - name: Wait for index propagation (30s)
        run: sleep 30

      # Tier 1: Crates depending only on tds-protocol
      - name: Publish mssql-tls
        run: cargo publish -p mssql-tls --no-verify
        continue-on-error: true

      - name: Publish mssql-codec
        run: cargo publish -p mssql-codec --no-verify
        continue-on-error: true

      - name: Publish mssql-auth
        run: cargo publish -p mssql-auth --no-verify
        continue-on-error: true

      # Tier 2: Proc-macro crate (no internal runtime deps)
      - name: Publish mssql-derive
        run: cargo publish -p mssql-derive --no-verify
        continue-on-error: true

      # Wait for index propagation
      - name: Wait for index propagation (30s)
        run: sleep 30

      # Tier 3: Main client (depends on tds-protocol, mssql-tls, mssql-codec, mssql-types, mssql-auth)
      - name: Publish mssql-client
        run: cargo publish -p mssql-client --no-verify
        continue-on-error: true

      - name: Wait for index propagation (30s)
        run: sleep 30

      # Tier 4: Crates depending on mssql-client
      - name: Publish mssql-driver-pool
        run: cargo publish -p mssql-driver-pool --no-verify
        continue-on-error: true

      - name: Publish mssql-testing
        run: cargo publish -p mssql-testing --no-verify
        continue-on-error: true

  # Dry run verification - tests all crates in dependency order
  dry-run:
    name: Dry Run Publish
    runs-on: ubuntu-latest
    needs: [semver-check, test, security-audit, docs]
    if: ${{ inputs.dry_run }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Verify all crates publishable
        run: |
          # Test all crates in dependency tier order
          for crate in tds-protocol mssql-types mssql-tls mssql-codec mssql-auth mssql-derive mssql-client mssql-driver-pool mssql-testing; do
            echo "Checking $crate..."
            cargo publish -p $crate --dry-run --no-verify
          done
          echo "All crates verified for publishing"

  # Create GitHub release
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [publish]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      - name: Generate changelog
        id: changelog
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Try to extract changelog section for this version
          if [ -f CHANGELOG.md ]; then
            awk "/^## \[${VERSION}\]/{found=1;next} /^## \[/{found=0} found" CHANGELOG.md > release_notes.md
          else
            echo "Release $VERSION" > release_notes.md
          fi

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          generate_release_notes: true
